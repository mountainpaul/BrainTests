name: Flutter CI with Concurrency Tests (Optimized)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Cancel in-progress runs when a new workflow is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Setup job - shared dependencies
  setup:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable

    - name: Install dependencies
      run: flutter pub get

    - name: Run code generation
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: Upload build artifacts for parallel jobs
      uses: actions/upload-artifact@v3
      with:
        name: flutter-setup
        path: |
          .dart_tool/
          pubspec.lock

  # Code quality checks (fast)
  analyze:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs
    - name: Analyze code
      run: flutter analyze --no-fatal-infos

  # Parallel test jobs
  test-new-services:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Test Timer Provider
      run: flutter test test/unit/presentation/providers/timer_provider_test.dart --reporter=compact

    - name: Test State Synchronization
      run: flutter test test/unit/core/services/state_synchronization_test.dart --reporter=compact

    - name: Test Error Handler
      run: flutter test test/unit/core/services/error_handler_test.dart --reporter=compact

    - name: Test Production Monitoring
      run: flutter test test/unit/core/services/production_monitoring_test.dart --reporter=compact

  test-unit:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Run unit tests (excluding new services)
      run: |
        flutter test test/unit \
          --exclude-tags=slow \
          --reporter=compact \
          --exclude=test/unit/presentation/providers/timer_provider_test.dart \
          --exclude=test/unit/core/services/state_synchronization_test.dart \
          --exclude=test/unit/core/services/error_handler_test.dart \
          --exclude=test/unit/core/services/production_monitoring_test.dart

  test-widget:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Run widget tests
      run: flutter test test/widget --reporter=compact

  test-integration:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Run integration tests
      run: flutter test test/integration --reporter=compact

  test-concurrency:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Run concurrency tests
      run: flutter test test/concurrency --reporter=compact

  test-performance:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Run performance stress tests
      run: flutter test test/integration/performance_stress_test.dart --reporter=compact

  audit-dispose:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Run StatefulWidget dispose audit
      run: flutter test test/audit/stateful_widget_dispose_audit.dart --reporter=compact

  # Coverage job - runs after all tests
  coverage:
    runs-on: ubuntu-latest
    needs: [test-new-services, test-unit, test-widget, test-integration, test-concurrency, test-performance, audit-dispose]
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Generate test coverage
      run: flutter test --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        fail_ci_if_error: false

  # Build job - runs in parallel with tests
  build:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: stable
        channel: stable
    - run: flutter pub get
    - run: dart run build_runner build --delete-conflicting-outputs

    - name: Build APK
      run: flutter build apk --debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: app-debug
        path: build/app/outputs/flutter-apk/app-debug.apk

  # Summary job - marks overall success
  all-tests-passed:
    runs-on: ubuntu-latest
    needs: [analyze, test-new-services, test-unit, test-widget, test-integration, test-concurrency, test-performance, audit-dispose, build]
    if: always()
    steps:
    - name: Check if all jobs passed
      run: |
        if [[ "${{ needs.analyze.result }}" != "success" ]] || \
           [[ "${{ needs.test-new-services.result }}" != "success" ]] || \
           [[ "${{ needs.test-unit.result }}" != "success" ]] || \
           [[ "${{ needs.test-widget.result }}" != "success" ]] || \
           [[ "${{ needs.test-integration.result }}" != "success" ]] || \
           [[ "${{ needs.test-concurrency.result }}" != "success" ]] || \
           [[ "${{ needs.test-performance.result }}" != "success" ]] || \
           [[ "${{ needs.audit-dispose.result }}" != "success" ]] || \
           [[ "${{ needs.build.result }}" != "success" ]]; then
          echo "❌ Some jobs failed"
          exit 1
        else
          echo "✅ All jobs passed successfully!"
        fi
